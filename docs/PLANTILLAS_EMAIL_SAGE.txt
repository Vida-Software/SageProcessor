# Sistema de Plantillas de Email para SAGE

## Descripción General

El Sistema de Plantillas de Email es una mejora para SAGE que permitirá tener mayor flexibilidad en las comunicaciones por email y otros canales, manteniendo la compatibilidad con el sistema actual y permitiendo una personalización por suscriptor.

## Requisitos Fundamentales

1. Mantener la compatibilidad actual: Siempre debe existir una plantilla por defecto para cada tipo de comunicación para garantizar que el sistema siga funcionando sin interrupción.

2. Ubicación en la interfaz: La configuración de plantillas estará accesible desde el menú de configuración del sistema (símbolo de engranaje en la esquina superior derecha), debajo de "Configuraciones API".

3. Sin disrupción: La implementación debe ser gradual y no afectar el funcionamiento actual de SAGE.

## Estructura del Sistema

### 1. Modelo de Datos

#### 1.1 Tabla de Plantillas

CREATE TABLE plantillas_email (
    id SERIAL PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT,
    tipo VARCHAR(50) NOT NULL, -- notificacion, respuesta_daemon, etc.
    subtipo VARCHAR(50), -- detallado, resumido_emisor, etc.
    variante VARCHAR(50) DEFAULT 'standard', -- standard, marketing, etc.
    canal VARCHAR(50) DEFAULT 'email', -- email, whatsapp, telegram, etc.
    idioma VARCHAR(10) DEFAULT 'es',
    asunto VARCHAR(200), -- Para email
    contenido_html TEXT, -- Para email
    contenido_texto TEXT, -- Versión texto plano
    es_predeterminada BOOLEAN DEFAULT FALSE, -- Si es la plantilla predeterminada
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_modificacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    creador_id INTEGER,
    version INTEGER DEFAULT 1,
    estado VARCHAR(20) DEFAULT 'activo' -- activo, borrador, inactivo
);

#### 1.2 Expansión de la Tabla de Suscripciones

ALTER TABLE suscripciones ADD COLUMN plantilla_id INTEGER REFERENCES plantillas_email(id);

### 2. Tipos de Plantillas Identificados

#### 2.1 Notificaciones del Sistema

- Detallado: Información completa de eventos
- Resumido por Emisor: Agrupación por emisor
- Resumido por Casilla: Resumen a nivel de casilla

#### 2.2 Respuestas Automáticas (SAGE Daemon 2)

- Remitente No Autorizado: Informando que el remitente no está autorizado
- Falta de Adjunto: Solicitando archivo adjunto
- Procesamiento Exitoso: Confirmación de procesamiento correcto
- Procesamiento con Errores: Notificación de errores en el proceso
- Procesamiento con Advertencias: Notificación de advertencias

#### 2.3 Mensajes de Diagnóstico

- Prueba de Conexión: Confirmación de conexión exitosa
- Diagnóstico de Email: Resultados de diagnóstico

### 3. Componentes del Sistema

#### 3.1 Gestor de Plantillas

El gestor de plantillas es responsable de cargar y gestionar plantillas:
- Obtiene plantillas según tipo, subtipo, variante, etc.
- Siempre tiene una plantilla predeterminada como fallback
- Mantiene caché para rendimiento

#### 3.2 Renderizador de Plantillas

El renderizador de plantillas procesa las plantillas con datos:
- Interpola variables en el contenido
- Genera versiones HTML y texto plano
- Sanitiza contenido para seguridad

#### 3.3 Integración con Notificador Existente

Modificación mínima para usar el sistema de plantillas manteniendo compatibilidad con el código existente:
- Obtener asunto como se hace actualmente
- Si hay una plantilla personalizada para este suscriptor, usarla
- Si no, utilizar la lógica actual (plantilla predeterminada)

### 4. Interfaz de Administración

#### 4.1 Sección en Menú de Configuración 

- Ubicación: Menú gear (superior derecho) > Configuración Sistema > Configuración de Plantillas Email
- Esta sección permitirá:
  - Ver plantillas existentes
  - Crear nuevas plantillas
  - Editar plantillas (excepto las predeterminadas)
  - Asignar plantillas a suscriptores

#### 4.2 Editor de Plantillas

- Editor WYSIWYG para contenido HTML
- Editor de texto para versión plana
- Previsualización en múltiples formatos
- Sistema de variables para inserción dinámica de contenido

### 5. Estrategia de Implementación

#### 5.1 Fase 1: Estructura Base

- Implementar tablas de base de datos
- Crear el TemplateManager básico
- Transferir las plantillas actuales (hardcodeadas) a la base de datos como plantillas predeterminadas

#### 5.2 Fase 2: Compatibilidad con Sistema Actual

- Modificar Notificador para usar TemplateManager con fallback a sistema actual
- Crear punto de integración en Daemon2 manteniendo lógica actual como predeterminada

#### 5.3 Fase 3: Interfaz de Administración

- Implementar sección en menú de Configuración
- Crear editor de plantillas
- Implementar visor de plantillas predeterminadas (solo lectura)

#### 5.4 Fase 4: Personalización por Suscriptor

- Ampliar tabla de suscripciones
- Implementar selección de plantillas en configuración de suscripciones
- Desarrollar lógica de preferencias por suscriptor

### 6. Flujo de Trabajo para Uso

#### 6.1 Plantillas Predeterminadas

- Cada tipo de comunicación siempre tendrá una plantilla predeterminada
- Las plantillas predeterminadas no se pueden eliminar
- Las plantillas predeterminadas se pueden ver pero no editar
- Si un suscriptor no tiene plantilla asignada, se usa la predeterminada

#### 6.2 Creación de Nuevas Plantillas

1. Administrador accede a Configuración > Configuración de Plantillas Email
2. Selecciona "Nueva Plantilla"
3. Elige tipo, subtipo, variante e idioma
4. Edita contenido HTML y texto plano
5. Guarda la plantilla

#### 6.3 Asignación de Plantillas a Suscriptores

1. Administrador accede a Gestión de Suscripciones
2. Selecciona un suscriptor existente
3. En la sección "Preferencias de Comunicación", selecciona una plantilla
4. Guarda los cambios

### 7. Consideraciones Importantes

#### 7.1 Seguridad

- Validación estricta de HTML para prevenir XSS
- Control de acceso basado en roles para edición de plantillas
- Sanitización de variables inyectadas en plantillas

#### 7.2 Rendimiento

- Caché de plantillas para reducir consultas a la base de datos
- Renderizado optimizado para envíos masivos
- Monitoreo de tiempos de renderizado y envío

#### 7.3 Extensibilidad

- Diseño pensado para futura expansión a otros canales (WhatsApp, Telegram)
- Estructura de datos que permite versiones múltiples de cada plantilla
- Soporte para internacionalización desde el inicio

## Conclusiones

El sistema de plantillas propuesto ofrece una solución flexible y potente que:

1. Mantiene total compatibilidad con el sistema actual gracias a las plantillas predeterminadas
2. Permite personalización por suscriptor
3. Establece las bases para comunicación multicanal futura
4. Se integra de forma natural en la interfaz existente
5. Puede implementarse de forma gradual sin afectar la funcionalidad actual

Este enfoque garantiza que SAGE continúe funcionando sin interrupciones mientras se añade mayor flexibilidad y personalización a sus comunicaciones.
